<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.DIVE2025.domain.rescued.mapper.RescuedQueryMapper">

    <!-- Í≥µÌÜµ WHERE (protection_status Ï°∞Í±¥ ÏóÜÏùå) -->
    <sql id="COMMON_WHERE">
        WHERE 1=1
        <if test="q.shelterId != null">
            AND r.shelter_id = #{q.shelterId}
        </if>

        <!-- ‚úÖ care_reg_no: Ïó¨Îü¨ Í∞úÍ∞Ä Ïò§Î©¥ IN, ÏïÑÎãàÎ©¥ Îã®Ïùº = -->
        <choose>
            <when test="q.careRegNos != null and q.careRegNos.size() > 0">
                AND r.care_reg_no IN
                <foreach collection="q.careRegNos" item="crn" open="(" separator="," close=")">
                    #{crn}
                </foreach>
            </when>
            <when test="q.careRegNo != null and q.careRegNo != ''">
                AND r.care_reg_no = #{q.careRegNo}
            </when>
            <!-- Îëò Îã§ ÏóÜÏúºÎ©¥ care_reg_no Ï°∞Í±¥ ÎØ∏Ï†ÅÏö© -->
        </choose>

        <if test="q.sex != null">
            AND r.sex = #{q.sex}
        </if>
        <if test="q.neuterYn != null">
            AND r.neuter_yn = #{q.neuterYn}
        </if>
        <if test="q.upkindNm != null and q.upkindNm != ''">
            AND r.up_kind_nm = #{q.upkindNm}
        </if>
        <if test="q.kindNm != null and q.kindNm != ''">
            AND r.kind_nm LIKE CONCAT('%', #{q.kindNm}, '%')
        </if>

        <if test="q.rescueDateFrom != null">
            AND r.happen_dt &gt;= #{q.rescueDateFrom}
        </if>
        <if test="q.rescueDateTo != null">
            AND r.happen_dt &lt;= #{q.rescueDateTo}
        </if>

        <if test="q.keyword != null and q.keyword != ''">
            AND (
            r.kind_nm LIKE CONCAT('%', #{q.keyword}, '%')
            OR r.weight  LIKE CONCAT('%', #{q.keyword}, '%')
            OR r.age     LIKE CONCAT('%', #{q.keyword}, '%')
            )
        </if>
    </sql>


    <!-- Î™©Î°ù Ï°∞Ìöå -->
    <select id="findAnimalsByShelter"
            parameterType="map"
            resultType="com.example.DIVE2025.domain.rescued.dto.RescuedResponseDto">
        <!-- ÏïàÏ†ÑÌïú Ï†ïÏàò Ïò§ÌîÑÏÖã Î∞îÏù∏Îî© -->
        <bind name="offset" value="q.page * q.size"/>

        SELECT
        /* Í∏∞Î≥∏ ÏãùÎ≥Ñ */
        r.id                           AS id,
        r.desertion_no                 AS desertionNo,

        /* Î≥¥Ìò∏ÏÜå Ï†ïÎ≥¥ */
        r.shelter_id                   AS shelterId,
        s.description                  AS shelterName,
        s.shelter_feature              AS shelterFeature,
        s.latitude                     AS latitude,
        s.longitude                    AS longitude,
        s.tel                          AS shelterTel,
        s.addr                         AS shelterAddr,

        /* ÎèôÎ¨º Í∏∞Î≥∏ */
        r.up_kind_nm                   AS upkindNm,
        r.kind_nm                      AS kindNm,
        r.age                          AS age,
        r.weight                       AS weight,
        r.sex                          AS sex,
        r.neuter_yn                    AS neuterYn,

        /* ÏÉÅÌÉú/ÏùºÏûê */
        r.protection_status            AS protectionStatus,
        r.happen_dt                    AS happenDt,
        r.rescue_date                  AS rescueDate,
        r.move_date                    AS moveDate,
        r.protect_end_date             AS protectEndDate,

        /* Í∏∞ÌÉÄ */
        r.care_reg_no                  AS careRegNo,
        r.rfid_cd                      AS rfidCd,
        r.popfile1                     AS popfile1,
        r.popfile2                     AS popfile2,

        /* Í≥µÌÜµ Í≥ÑÏÇ∞ ÌïÑÎìú (ÏùºÍ¥ÄÌôî: happen_dt ÏóÜÏúºÎ©¥ rescue_date ÏÇ¨Ïö©) */
        DATEDIFF(CURDATE(), COALESCE(r.happen_dt, r.rescue_date)) AS daysProtected,
        CASE WHEN DATEDIFF(CURDATE(), COALESCE(r.happen_dt, r.rescue_date)) > 10
        THEN TRUE ELSE FALSE END                           AS overdue,
        /* 2Î≤à Í∏∞Îä•ÏóêÏÑú ServiceÍ∞Ä Ï±ÑÏö∏ ÏòàÏ†ï (ÏßÄÍ∏àÏùÄ null) */
        NULL                           AS needsTransfer

        FROM rescued r
        JOIN shelter s ON s.id = r.shelter_id

        <include refid="COMMON_WHERE"/>

        <!-- Ï†ïÎ†¨: Í∏∞Î≥∏ rescue_date, ÎåÄÏïà happen_dt/age/weight(Ïà´Ïûê ÏùòÎØ∏ Ï†ïÎ†¨) -->
        <choose>
            <when test="q.sort == 'happenDt'">
                ORDER BY r.happen_dt
            </when>

            <!-- age: "8ÏÇ¥ 3Í∞úÏõî", "2ÏÇ¥", "11Í∞úÏõî" ‚Üí Ï¥ù Í∞úÏõî ÏàòÎ°ú Ï†ïÎ†¨ + Ïà´Ïûê Î™ª ÎΩëÏùÄ ÌñâÏùÄ Îí§Î°ú -->
            <when test="q.sort == 'age'">
                <![CDATA[
          ORDER BY
            (
              REGEXP_SUBSTR(r.age, '(\d+)\s*(?:ÏÇ¥|ÏÑ∏|ÎÖÑ|y|yr|yrs|years)') IS NULL
              AND REGEXP_SUBSTR(r.age, '(\d+)\s*(?:Í∞úÏõî|Îã¨|mo|mos|month|months)') IS NULL
            ),
            (
              COALESCE(CAST(REGEXP_SUBSTR(r.age, '(\d+)\s*(?:ÏÇ¥|ÏÑ∏|ÎÖÑ|y|yr|yrs|years)') AS UNSIGNED), 0) * 12 +
              COALESCE(CAST(REGEXP_SUBSTR(r.age, '(\d+)\s*(?:Í∞úÏõî|Îã¨|mo|mos|month|months)') AS UNSIGNED), 0)
            )
        ]]>
            </when>

            <!-- weight: "ÏïΩ 6.5kg", "7 kg" Îì± ‚Üí Ïà´ÏûêÎßå Ï∂îÏ∂úÌï¥ Ï†ïÎ†¨ + Ïà´Ïûê Î™ª ÎΩëÏùÄ ÌñâÏùÄ Îí§Î°ú -->
            <when test="q.sort == 'weight'">
                <![CDATA[
          ORDER BY
            CAST(REGEXP_SUBSTR(LOWER(r.weight), '[0-9]+(\.[0-9]+)?') AS DECIMAL(10,2)) IS NULL,
            CAST(REGEXP_SUBSTR(LOWER(r.weight), '[0-9]+(\.[0-9]+)?') AS DECIMAL(10,2))
        ]]>
            </when>

            <otherwise>
                ORDER BY r.rescue_date
            </otherwise>
        </choose>

        <!-- Ï†ïÎ†¨ Î∞©Ìñ•: ASC/ DESC (ÏúÑÏóêÏÑú ÎßàÏßÄÎßâ ÌÇ§ÏóêÎßå Ï†ÅÏö©Îê®) -->
        <choose>
            <when test="q.order != null and (q.order == 'asc' or q.order == 'ASC')"> ASC </when>
            <otherwise> DESC </otherwise>
        </choose>

        LIMIT #{q.size}
        OFFSET #{offset}
    </select>


    <!-- Ïπ¥Ïö¥Ìä∏: PK Í∏∞Ï§Ä -->
    <select id="countByShelter" resultType="long">
        SELECT COUNT(*) FROM rescued r
        WHERE r.shelter_id = #{shelterId}
    </select>

    <!-- Ïπ¥Ïö¥Ìä∏: Îì±Î°ùÎ≤àÌò∏ Í∏∞Ï§Ä -->
    <select id="countByCareRegNo" resultType="long">
        SELECT COUNT(*) FROM rescued r
        WHERE r.care_reg_no = #{careRegNo}
    </select>

    <!-- Î≥¥Ìò∏ÏÑºÌÑ∞Î≥Ñ Í∑∏Î£π Ïπ¥Ïö¥Ìä∏ -->
    <select id="countGroupByShelter" resultType="java.util.HashMap">
        SELECT r.shelter_id AS shelterId, COUNT(*) AS count
        FROM rescued r
        GROUP BY r.shelter_id
        ORDER BY r.shelter_id ASC
    </select>

    <!-- ÌäπÏ†ï Î≥¥Ìò∏ÏÑºÌÑ∞Ïùò ÏßÄÏó≠Íµ¨Î≥Ñ Ïπ¥Ïö¥Ìä∏ -->
    <select id="countByShelterGroupByCareRegNo" resultType="hashmap">
        SELECT
            r.care_reg_no AS careRegNo,
            COUNT(*)      AS count
        FROM rescued r
        WHERE r.shelter_id = #{shelterId}
        GROUP BY r.care_reg_no
        ORDER BY r.care_reg_no
    </select>


    <select id="findTransferCandidates"
            resultType="com.example.DIVE2025.domain.rescued.dto.RescuedResponseDto">

        SELECT
        /* Í∏∞Î≥∏ ÏãùÎ≥Ñ */
        r.id                           AS id,
        r.desertion_no                 AS desertionNo,

        /* Î≥¥Ìò∏ÏÜå Ï†ïÎ≥¥ */
        r.shelter_id                   AS shelterId,
        s.description                  AS shelterName,
        s.shelter_feature              AS shelterFeature,
        s.latitude                     AS latitude,
        s.longitude                    AS longitude,
        s.tel                          AS shelterTel,
        s.addr                         AS shelterAddr,

        /* ÎèôÎ¨º Í∏∞Î≥∏ */
        r.up_kind_nm                   AS upkindNm,
        r.kind_nm                      AS kindNm,
        r.age                          AS age,
        r.weight                       AS weight,
        r.sex                          AS sex,
        r.neuter_yn                    AS neuterYn,

        /* ÏÉÅÌÉú/ÏùºÏûê */
        r.protection_status            AS protectionStatus,
        r.animal_condition             AS animalCondition,
        r.happen_dt                    AS happenDt,
        r.rescue_date                  AS rescueDate,
        r.move_date                    AS moveDate,
        r.protect_end_date             AS protectEndDate,

        /* Í∏∞ÌÉÄ */
        r.care_reg_no                  AS careRegNo,
        r.rfid_cd                      AS rfidCd,
        r.popfile1                     AS popfile1,
        r.popfile2                     AS popfile2,

        /* Í≥µÌÜµ Í≥ÑÏÇ∞ ÌïÑÎìú(Ï°∞ÌöåÏö©) */
        DATEDIFF(CURRENT_DATE, COALESCE(r.happen_dt, r.rescue_date)) AS daysProtected,

        CASE
        WHEN DATEDIFF(CURRENT_DATE, COALESCE(r.happen_dt, r.rescue_date)) > 10
        THEN TRUE ELSE FALSE
        END AS overdue,

        CASE
        -- Î≥¥Ìò∏Í∏∞Í∞Ñ Ï¥àÍ≥º OR ÏßàÎ≥ëÏ°∞Í±¥ Î∂àÏùºÏπò ‚Üí Ïù¥Í¥Ä ÌïÑÏöî
        WHEN DATEDIFF(CURRENT_DATE, COALESCE(r.happen_dt, r.rescue_date)) > 10
        OR (r.animal_condition = 'MILD'   AND s.shelter_feature = 'GENERAL')
        OR (r.animal_condition = 'SEVERE' AND (s.shelter_feature = 'GENERAL' OR s.shelter_feature = 'VET'))
        THEN TRUE ELSE FALSE
        END AS needsTransfer

        FROM rescued r
        JOIN shelter s ON s.id = r.shelter_id

        <where>
            r.shelter_id = #{shelterId}
            AND r.protection_status = 'PROTECTED'

            <!-- ‚úÖ Í∏∞Î≥∏ Ìè¨Ìï®: (Î≥¥Ìò∏Í∏∞Í∞Ñ Ï¥àÍ≥º) OR (ÏßàÎ≥ë-Î≥¥Ìò∏ÏÜå Î∂àÏùºÏπò) -->
            AND (
            DATEDIFF(CURRENT_DATE, COALESCE(r.happen_dt, r.rescue_date)) > 10
            OR (r.animal_condition = 'MILD'   AND s.shelter_feature = 'GENERAL')
            OR (r.animal_condition = 'SEVERE' AND (s.shelter_feature = 'GENERAL' OR s.shelter_feature = 'VET'))
            )

            <!-- üîé ÏßàÎ≥ë Î∂àÏùºÏπòÎßå Î≥¥Í≥† Ïã∂ÏùÑ Îïå(Ï∂îÍ∞Ä ÌïÑÌÑ∞) -->
            <if test="useSeverity">
                AND (
                (r.animal_condition = 'MILD'   AND s.shelter_feature = 'GENERAL')
                OR
                (r.animal_condition = 'SEVERE' AND (s.shelter_feature = 'GENERAL' OR s.shelter_feature = 'VET'))
                )
            </if>

            <!-- üîé Î≥¥Ìò∏Í∏∞Í∞Ñ ÌïÑÌÑ∞(Ï∂îÍ∞Ä ÌïÑÌÑ∞) -->
            <!-- Í≤ΩÍ≥ºÎßå -->
            <if test="usePeriod and dueWithinDays == 0">
                <![CDATA[
    AND COALESCE(r.protect_end_date,
                 DATE_ADD(COALESCE(r.happen_dt, r.rescue_date), INTERVAL 10 DAY))
    < CURRENT_DATE
    ]]>
            </if>

            <!-- ÏûÑÎ∞ïÎßå -->
            <if test="usePeriod and dueWithinDays > 0">
                <![CDATA[
    AND COALESCE(r.protect_end_date,
                 DATE_ADD(COALESCE(r.happen_dt, r.rescue_date), INTERVAL 10 DAY))
    BETWEEN CURRENT_DATE AND DATE_ADD(CURRENT_DATE, INTERVAL #{dueWithinDays} DAY)
    ]]>
            </if>

            <!-- üîé ÌäπÏ†ï ÏÉÅÌÉúÎßå Î≥¥Í≥† Ïã∂ÏùÑ Îïå(Ï∂îÍ∞Ä ÌïÑÌÑ∞) -->
            <if test="conditions != null and conditions.size > 0">
                AND (
                <foreach collection="conditions" item="c" separator=" OR ">
                    r.animal_condition = #{c}
                </foreach>
                )
            </if>
        </where>


        <!-- ÎèôÏ†Å Ï†ïÎ†¨ -->
        <choose>
            <when test="sort != null and (sort == 'overdue' or sort == 'daysProtected' or sort == 'happenDt' or sort == 'rescueDate' or sort == 'age' or sort == 'weight')">
                <choose>
                    <when test="sort == 'overdue'">        ORDER BY overdue        </when>
                    <when test="sort == 'daysProtected'">  ORDER BY daysProtected  </when>
                    <when test="sort == 'happenDt'">       ORDER BY r.happen_dt    </when>
                    <when test="sort == 'rescueDate'">     ORDER BY r.rescue_date  </when>

                    <!-- ÎÇòÏù¥: Í∞úÏõî Îã®ÏúÑ ÌôòÏÇ∞ -->
                    <when test="sort == 'age'">
                        <![CDATA[
                    ORDER BY
                      (
                        REGEXP_SUBSTR(r.age, '(\\d+)\\s*(?:ÏÇ¥|ÏÑ∏|ÎÖÑ|y|yr|yrs|years)') IS NULL
                        AND REGEXP_SUBSTR(r.age, '(\\d+)\\s*(?:Í∞úÏõî|Îã¨|mo|mos|month|months)') IS NULL
                      ),
                      (
                        COALESCE(CAST(REGEXP_SUBSTR(r.age, '(\\d+)\\s*(?:ÏÇ¥|ÏÑ∏|ÎÖÑ|y|yr|yrs|years)') AS UNSIGNED), 0) * 12 +
                        COALESCE(CAST(REGEXP_SUBSTR(r.age, '(\\d+)\\s*(?:Í∞úÏõî|Îã¨|mo|mos|month|months)') AS UNSIGNED), 0)
                      )
                    ]]>
                    </when>

                    <!-- Î™∏Î¨¥Í≤å: Ïà´ÏûêÎßå Ï∂îÏ∂ú -->
                    <when test="sort == 'weight'">
                        <![CDATA[
                    ORDER BY
                      CAST(REGEXP_SUBSTR(LOWER(r.weight), '[0-9]+(\\.[0-9]+)?') AS DECIMAL(10,2)) IS NULL,
                      CAST(REGEXP_SUBSTR(LOWER(r.weight), '[0-9]+(\\.[0-9]+)?') AS DECIMAL(10,2))
                    ]]>
                    </when>
                </choose>

                <choose>
                    <when test="order != null and (order == 'asc' or order == 'ASC')"> ASC </when>
                    <otherwise> DESC </otherwise>
                </choose>
            </when>

            <otherwise>
                ORDER BY
                overdue DESC,
                daysProtected DESC,
                COALESCE(r.happen_dt, r.rescue_date) ASC
            </otherwise>
        </choose>

        <if test="limit != null and limit > 0">
            LIMIT #{limit}
            OFFSET #{offset}
        </if>

    </select>




</mapper>
